#!/usr/bin/env bash

server_details="/tmp/server_details_index.yaml"
#server_details="~/.dotfiles/binaries/bin/scripts/server_details_index.yaml"

eval server_details_path=$server_details

declare -A serversArray

lines=$(grep ":" $server_details_path)

while IFS= read -r line; do
  result=$(echo "$line" | awk -F ':' '/server/ {print $1 $2 $4}' | tr -d '{}' | sed 's/   / /g' | sed 's/production/prod/g')

  if [ -n "$result" ]; then

    project=$(echo "$result" | awk '{ print $1 "-" $2 }')
    server=$(echo "$result" | awk '{ print $3 }')

    serversArray["$project"]="$server"
  fi
done <<< $lines


# add all the found projects to a newline seperated string for fzf
for key in "${!serversArray[@]}"; do
  fzfList+="\n$key"
done

#remove leading newline
fzfList="${fzfList#\\n}"

selectedProject=$(echo -e "$fzfList" | fzf)

if [ -n "$selectedProject" ]; then
  selectedServer="${serversArray[$selectedProject]}"
  if [ -n "$selectedServer" ]; then
    ssh "$selectedServer"
  else
    echo "No server found for the selected project."
    exit
  fi
else
  echo "No projected selected. Exiting"
  exit
fi


